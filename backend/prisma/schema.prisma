// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id           String       @id @default(cuid())
  createdAt    DateTime     @default(now())
  lastActiveAt DateTime?
  userAgent    String?
  ipHash       String?      // hashed IP for analytics, not PII
  generations  Generation[]
  assets       Asset[]

  @@map("sessions")
}

model Asset {
  id         String   @id @default(cuid())
  sessionId  String
  filename   String
  mime       String
  sizeBytes  Int
  width      Int?
  height     Int?
  storageKey String   // path in Supabase Storage: sessions/{sessionId}/assets/{assetId}/{filename}
  role       String   // "model" | "garment" | "fabric" | "style_ref"
  deletedAt  DateTime?
  createdAt  DateTime @default(now())

  session     Session      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  generations GenerationAsset[]

  @@map("assets")
}

model Generation {
  id                 String    @id @default(cuid())
  sessionId          String
  parentGenerationId String?
  prompt             String    @db.Text
  params             Json      // PromptParams object
  status             String    @default("queued")  // queued | processing | completed | failed | cancelled
  kieTaskIds         Json      @default("[]")       // string[] of Kie AI task IDs (one per variation)
  variationsTotal    Int       @default(1)
  variationsDone     Int       @default(0)
  failureReason      String?
  deletedAt          DateTime?
  createdAt          DateTime  @default(now())
  startedAt          DateTime?
  completedAt        DateTime?

  session    Session            @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  parent     Generation?        @relation("Revisions", fields: [parentGenerationId], references: [id])
  children   Generation[]       @relation("Revisions")
  assets     GenerationAsset[]
  outputs    GenerationOutput[]
  jobLogs    JobLog[]

  @@index([sessionId, createdAt(sort: Desc)])
  @@index([status])
  @@map("generations")
}

// Explicit many-to-many join table between Generation and Asset
model GenerationAsset {
  generationId String
  assetId      String
  generation   Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)
  asset        Asset      @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@id([generationId, assetId])
  @@map("generation_assets")
}

model GenerationOutput {
  id           String    @id @default(cuid())
  generationId String
  kieTaskId    String    // the specific Kie AI task ID for this variation
  storageKey   String    // path in Supabase Storage
  mime         String    @default("image/png")
  sizeBytes    Int?
  width        Int?
  height       Int?
  metadata     Json?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())

  generation Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@index([generationId])
  @@map("generation_outputs")
}

model JobLog {
  id           String   @id @default(cuid())
  generationId String?
  event        String   // e.g. "job.queued" | "kie.submitted" | "kie.callback" | "output.stored" | "job.failed" | "retention.deleted"
  payload      Json?
  createdAt    DateTime @default(now())

  generation Generation? @relation(fields: [generationId], references: [id], onDelete: SetNull)

  @@index([generationId, createdAt])
  @@map("job_logs")
}
